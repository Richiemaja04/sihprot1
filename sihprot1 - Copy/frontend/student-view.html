<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Timetable - TimetableAI</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animations.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .student-view {
            padding-top: 80px;
            min-height: 100vh;
        }

        .timetable-header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            text-align: center;
        }

        .batch-info {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .info-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .timetable-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            overflow-x: auto;
        }

        .timetable-grid {
            display: grid;
            grid-template-columns: 120px repeat(5, 1fr);
            gap: 1px;
            background: var(--glass-border);
            border-radius: var(--radius-md);
            overflow: hidden;
            min-width: 800px;
        }

        .time-header,
        .day-header,
        .timetable-cell {
            background: var(--glass-bg);
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            position: relative;
            transition: all var(--transition-medium);
        }

        .time-header,
        .day-header {
            background: rgba(102, 126, 234, 0.1);
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timetable-cell {
            cursor: pointer;
            text-align: center;
        }

        .timetable-cell:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .timetable-cell.empty {
            opacity: 0.3;
            cursor: default;
        }

        .timetable-cell.empty:hover {
            transform: none;
            background: var(--glass-bg);
            box-shadow: none;
        }

        .subject-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            font-size: 0.9rem;
            line-height: 1.2;
        }

        .faculty-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .room-name {
            font-size: 0.8rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .subject-type-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .type-theory {
            background: #10b981;
        }

        .type-lab {
            background: #f59e0b;
        }

        .type-practical {
            background: #ef4444;
        }

        .subjects-summary {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .subject-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            transition: all var(--transition-medium);
        }

        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }

        .subject-title {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .credits-badge {
            background: var(--gradient-primary);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .subject-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .weekly-summary {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .day-summary {
            text-align: center;
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
        }

        .day-name {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }

        .day-hours {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .actions-bar {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .back-button {
            position: fixed;
            top: 90px;
            left: 20px;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: var(--spacing-md);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-medium);
            text-decoration: none;
        }

        .back-button:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .mobile-scroll-hint {
            display: none;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: var(--spacing-sm);
        }

        @media (max-width: 768px) {
            .student-view {
                padding: 80px var(--spacing-md) var(--spacing-md);
            }

            .batch-info {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-md);
            }

            .timetable-container {
                padding: var(--spacing-md);
            }

            .mobile-scroll-hint {
                display: block;
            }

            .subjects-grid {
                grid-template-columns: 1fr;
            }

            .weekly-summary {
                grid-template-columns: repeat(3, 1fr);
            }

            .actions-bar {
                flex-direction: column;
                align-items: center;
            }

            .legend {
                flex-direction: column;
                align-items: center;
                gap: var(--spacing-sm);
            }
        }
    </style>
</head>
<body class="student-view">
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="floating-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar glass-nav">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-calendar-alt"></i>
                <span>TimetableAI</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i> Home
                </a>
            </div>
        </div>
    </nav>

    <!-- Back Button -->
    <a href="/" class="back-button" title="Back to Home">
        <i class="fas fa-arrow-left"></i>
    </a>

    <!-- Main Content -->
    <div class="container">
        <!-- Timetable Header -->
        <div class="timetable-header slide-up">
            <h1 id="pageTitle">My Timetable</h1>
            <div class="batch-info" id="batchInfo">
                <!-- Batch info will be loaded here -->
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="actions-bar slide-up-delay">
            <button class="btn-secondary" onclick="printTimetable()">
                <i class="fas fa-print"></i> Print
            </button>
            <button class="btn-secondary" onclick="exportToPDF()">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            <button class="btn-secondary" onclick="shareSchedule()">
                <i class="fas fa-share"></i> Share
            </button>
        </div>

        <!-- Timetable Grid -->
        <div class="timetable-container slide-up">
            <div class="timetable-grid" id="timetableGrid">
                <!-- Timetable will be loaded here -->
            </div>
            <div class="mobile-scroll-hint">
                <i class="fas fa-arrows-alt-h"></i> Scroll horizontally to see more
            </div>
            
            <!-- Legend -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot type-theory"></div>
                    <span>Theory</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot type-lab"></div>
                    <span>Lab</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot type-practical"></div>
                    <span>Practical</span>
                </div>
            </div>
        </div>

        <!-- Weekly Summary -->
        <div class="subjects-summary slide-up">
            <h2>
                <i class="fas fa-chart-bar"></i>
                Weekly Summary
            </h2>
            <div class="weekly-summary" id="weeklySummary">
                <!-- Weekly summary will be loaded here -->
            </div>
        </div>

        <!-- Subjects Summary -->
        <div class="subjects-summary slide-up">
            <h2>
                <i class="fas fa-book"></i>
                Subjects Overview
            </h2>
            <div class="subjects-grid" id="subjectsGrid">
                <!-- Subjects will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading your timetable...</p>
        </div>
    </div>

    <!-- Notification System -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Subject Details Modal -->
    <div id="subjectModal" class="modal">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h3 id="modalSubjectName">Subject Details</h3>
                <span class="close-btn" onclick="hideSubjectModal()">Ã—</span>
            </div>
            <div class="modal-body" id="modalSubjectContent">
                <!-- Subject details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/timetable-renderer.js"></script>
    <script>
        class StudentTimetableView {
            constructor() {
                this.department = '';
                this.level = '';
                this.semester = '';
                this.timetableData = null;
                this.subjectsData = null;
                
                this.init();
            }

            async init() {
                try {
                    this.loadSelections();
                    await this.loadTimetableData();
                    this.renderTimetable();
                    this.renderSubjects();
                    this.initializeEventListeners();
                } catch (error) {
                    console.error('Failed to initialize student view:', error);
                    showNotification('Failed to load timetable data', 'error');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                }
            }

            loadSelections() {
                this.department = sessionStorage.getItem('selectedDepartment');
                this.level = sessionStorage.getItem('selectedLevel');
                this.semester = sessionStorage.getItem('selectedSemester');

                if (!this.department || !this.level || !this.semester) {
                    showNotification('Please select your program first', 'warning');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    throw new Error('Missing selection data');
                }
            }

            async loadTimetableData() {
                try {
                    // Load timetable grid data
                    this.timetableData = await api.getTimetableGrid(
                        this.department, 
                        this.level, 
                        this.semester
                    );

                    // Load subjects data
                    this.subjectsData = await api.getBatchSubjects(
                        this.department, 
                        this.level, 
                        this.semester
                    );

                    // Update page title
                    document.getElementById('pageTitle').textContent = 
                        `${this.department} ${this.level} - Semester ${this.semester}`;

                } catch (error) {
                    console.error('Error loading timetable data:', error);
                    throw error;
                }
            }

            renderTimetable() {
                if (!this.timetableData) return;

                // Render batch info
                this.renderBatchInfo();

                // Render timetable grid
                const grid = document.getElementById('timetableGrid');
                grid.innerHTML = '';

                // Time header
                const timeHeader = document.createElement('div');
                timeHeader.className = 'time-header';
                timeHeader.textContent = 'Time';
                grid.appendChild(timeHeader);

                // Day headers
                this.timetableData.days.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    grid.appendChild(dayHeader);
                });

                // Time slots and cells
                this.timetableData.time_slots.forEach((timeSlot, hourIndex) => {
                    const hour = hourIndex + 1;
                    
                    // Time cell
                    const timeCell = document.createElement('div');
                    timeCell.className = 'time-header';
                    timeCell.innerHTML = `
                        <div>${timeSlot}</div>
                        <small>${this.formatTime(hour)}</small>
                    `;
                    grid.appendChild(timeCell);

                    // Day cells
                    this.timetableData.days.forEach(day => {
                        const cellData = this.timetableData.grid[day]?.[hour];
                        const cell = document.createElement('div');
                        
                        if (cellData) {
                            cell.className = 'timetable-cell';
                            cell.innerHTML = `
                                <div class="subject-type-indicator type-${cellData.subject_type.toLowerCase()}"></div>
                                <div class="subject-name">${cellData.subject_name}</div>
                                <div class="faculty-name">${cellData.faculty_name}</div>
                                <div class="room-name">${cellData.room_name}</div>
                            `;
                            cell.addEventListener('click', () => this.showSubjectDetails(cellData));
                        } else {
                            cell.className = 'timetable-cell empty';
                            cell.innerHTML = '<div style="color: var(--text-muted);">Free</div>';
                        }
                        
                        grid.appendChild(cell);
                    });
                });

                // Render weekly summary
                this.renderWeeklySummary();

                // Add animation
                grid.classList.add('timetable-grid');
            }

            renderBatchInfo() {
                const batchInfo = document.getElementById('batchInfo');
                batchInfo.innerHTML = `
                    <div class="info-item">
                        <div class="info-label">Department</div>
                        <div class="info-value">${this.timetableData.batch_info.department}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Level</div>
                        <div class="info-value">${this.timetableData.batch_info.level}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Semester</div>
                        <div class="info-value">${this.timetableData.batch_info.semester}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Students</div>
                        <div class="info-value">${this.timetableData.batch_info.student_count}</div>
                    </div>
                `;
            }

            renderWeeklySummary() {
                const summaryContainer = document.getElementById('weeklySummary');
                summaryContainer.innerHTML = '';

                this.timetableData.days.forEach(day => {
                    const hours = this.timetableData.weekly_summary[day] || 0;
                    const dayCard = document.createElement('div');
                    dayCard.className = 'day-summary';
                    dayCard.innerHTML = `
                        <div class="day-name">${day}</div>
                        <div class="day-hours">${hours}</div>
                        <small>hours</small>
                    `;
                    summaryContainer.appendChild(dayCard);
                });
            }

            renderSubjects() {
                if (!this.subjectsData) return;

                const subjectsGrid = document.getElementById('subjectsGrid');
                subjectsGrid.innerHTML = '';

                this.subjectsData.subjects.forEach(subject => {
                    const subjectCard = document.createElement('div');
                    subjectCard.className = 'subject-card hover-lift';
                    subjectCard.innerHTML = `
                        <div class="subject-header">
                            <div class="subject-title">${subject.name}</div>
                            <div class="credits-badge">${subject.credits} Credits</div>
                        </div>
                        <div class="subject-details">
                            <div>
                                <i class="fas fa-user"></i> ${subject.faculty}
                            </div>
                            <div>
                                <i class="fas fa-clock"></i> ${subject.hours_per_week}h/week
                            </div>
                            <div>
                                <i class="fas fa-tag"></i> ${subject.type}
                            </div>
                        </div>
                    `;
                    
                    subjectCard.addEventListener('click', () => {
                        this.showSubjectDetails(subject);
                    });
                    
                    subjectsGrid.appendChild(subjectCard);
                });
            }

            async showSubjectDetails(subjectData) {
                const modal = document.getElementById('subjectModal');
                const modalTitle = document.getElementById('modalSubjectName');
                const modalContent = document.getElementById('modalSubjectContent');

                modalTitle.textContent = subjectData.subject_name || subjectData.name;

                // If it's a subject from the subjects list
                if (subjectData.faculty) {
                    modalContent.innerHTML = `
                        <div class="subject-detail-card">
                            <h4>Subject Information</h4>
                            <p><strong>Code:</strong> ${subjectData.code || 'N/A'}</p>
                            <p><strong>Credits:</strong> ${subjectData.credits}</p>
                            <p><strong>Type:</strong> ${subjectData.type}</p>
                            <p><strong>Hours per Week:</strong> ${subjectData.hours_per_week}</p>
                            <p><strong>Faculty:</strong> ${subjectData.faculty}</p>
                        </div>
                    `;
                } else {
                    // If it's a timetable cell
                    modalContent.innerHTML = `
                        <div class="subject-detail-card">
                            <h4>Class Details</h4>
                            <p><strong>Subject:</strong> ${subjectData.subject_name}</p>
                            <p><strong>Faculty:</strong> ${subjectData.faculty_name}</p>
                            <p><strong>Room:</strong> ${subjectData.room_name}</p>
                            <p><strong>Type:</strong> ${subjectData.subject_type}</p>
                        </div>
                    `;
                }

                modal.style.display = 'flex';
                modal.querySelector('.modal-content').classList.add('modal-enter');
            }

            formatTime(hour) {
                const startHour = 8 + hour; // Assuming first period starts at 9 AM
                const endHour = startHour + 1;
                
                const formatHour = (h) => {
                    const period = h >= 12 ? 'PM' : 'AM';
                    const displayHour = h > 12 ? h - 12 : h === 0 ? 12 : h;
                    return `${displayHour}${period}`;
                };

                return `${formatHour(startHour)}-${formatHour(endHour)}`;
            }

            initializeEventListeners() {
                // Modal close
                const modal = document.getElementById('subjectModal');
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.hideSubjectModal();
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideSubjectModal();
                    }
                });
            }

            hideSubjectModal() {
                const modal = document.getElementById('subjectModal');
                const modalContent = modal.querySelector('.modal-content');
                
                modalContent.classList.remove('modal-enter');
                modalContent.classList.add('modal-exit');
                
                setTimeout(() => {
                    modal.style.display = 'none';
                    modalContent.classList.remove('modal-exit');
                }, 300);
            }
        }

        // Utility functions
        function hideSubjectModal() {
            if (window.studentView) {
                window.studentView.hideSubjectModal();
            }
        }

        function printTimetable() {
            window.print();
        }

        function exportToPDF() {
            showNotification('PDF export feature coming soon!', 'info');
        }

        function shareSchedule() {
            if (navigator.share) {
                navigator.share({
                    title: 'My Timetable',
                    text: 'Check out my class schedule!',
                    url: window.location.href
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href)
                    .then(() => showNotification('Link copied to clipboard!', 'success'))
                    .catch(() => showNotification('Unable to share', 'error'));
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.studentView = new StudentTimetableView();
        });
    </script>
</body>
</html>